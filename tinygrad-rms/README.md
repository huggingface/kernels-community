---
tags:
- kernel
---

# tinygrad-rms

RMSNorm CUDA kernels generated from tinygrad's compiler.

## Description

This kernel implements RMSNorm (Root Mean Square Layer Normalization) using kernels generated by tinygrad's compiler. The implementation uses a two-kernel approach:

1. **Kernel 1 (`r_N_4_4_8_128`)**: Computes `1/sqrt(mean(x^2) + epsilon)` for each row
2. **Kernel 2 (`E_N_16_8_16_4`)**: Multiplies input by the computed normalization factor

RMSNorm formula: `output = input * (1 / sqrt(mean(input^2) + epsilon))`

## Constraints

The tinygrad-generated kernels are optimized for specific tensor shapes:
- **hidden_size must be 1024**
- **num_rows must be divisible by 16**
- **dtype must be float32**

## Installation

```python
from kernels import get_kernel

tinygrad_rms = get_kernel("kernels-community/tinygrad-rms")
```

## Usage

```python
import torch
from kernels import get_kernel

tinygrad_rms = get_kernel("kernels-community/tinygrad-rms")

# Create input tensor (hidden_size=1024, num_rows divisible by 16)
x = torch.randn(32, 512, 1024, dtype=torch.float32, device="cuda")

# Simple interface (returns normalized output)
output = tinygrad_rms.tinygrad_rms_norm_simple(x, epsilon=1e-6)

# Full interface (returns output and rms_inv for potential reuse)
output, rms_inv = tinygrad_rms.tinygrad_rms_norm(x, epsilon=1e-6)

# With pre-allocated output
out = torch.empty_like(x)
output, rms_inv = tinygrad_rms.tinygrad_rms_norm(x, epsilon=1e-6, out=out)
```

## API

### `tinygrad_rms_norm(x, epsilon=1e-6, out=None)`

Full RMSNorm function that returns both the normalized output and the intermediate rms_inv tensor.

**Args:**
- `x`: Input tensor of shape `(..., 1024)` where total rows is divisible by 16
- `epsilon`: Small constant for numerical stability (default: 1e-6)
- `out`: Optional pre-allocated output tensor

**Returns:**
- Tuple of `(output, rms_inv)` tensors

### `tinygrad_rms_norm_simple(x, epsilon=1e-6, out=None)`

Simplified RMSNorm function that only returns the normalized output.

**Args:**
- `x`: Input tensor of shape `(..., 1024)` where total rows is divisible by 16
- `epsilon`: Small constant for numerical stability (default: 1e-6)
- `out`: Optional pre-allocated output tensor

**Returns:**
- Normalized output tensor

## Supported Backends

- CUDA

## Source

Kernels generated by [tinygrad](https://github.com/tinygrad/tinygrad) and are based on the output of [scripts/generate_kernel.py](scripts/generate_kernel.py). 
