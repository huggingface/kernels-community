[general]
name = "megablocks"
version = 1
backends = [
    "cuda",
    "xpu",
    "cpu",
]

[torch]
src = [
    "torch-ext/torch_binding.cpp",
    "torch-ext/torch_binding.h",
]

[kernel.megablocks]
backend = "cuda"
cuda-capabilities = [
    "7.0",
    "7.2",
    "7.5",
    "8.0",
    "8.6",
    "8.7",
    "8.9",
    "9.0",
    "10.0",
    "10.1",
    "11.8",
    "12.0",
]
depends = [
    "torch",
    "cutlass_3_8",
]
src = [
    "csrc/cumsum.h",
    "csrc/cumsum.cu",
    "csrc/histogram.h",
    "csrc/histogram.cu",
    "csrc/indices.h",
    "csrc/indices.cu",
    "csrc/replicate.h",
    "csrc/replicate.cu",
    "csrc/sort.h",
    "csrc/sort.cu",
    "csrc/grouped_gemm/fill_arguments.cuh",
    "csrc/grouped_gemm/grouped_gemm.cu",
    "csrc/grouped_gemm/grouped_gemm.h",
]

[kernel.megablocks_xpu]
backend = "xpu"
depends = [
    "torch",
    "cutlass_sycl",
]
src = [
    "csrc_xpu/utils.h",
    "csrc_xpu/dispatch_utils.h",
    "csrc_xpu/core/registration.h",
    "csrc_xpu/activation.cpp",
    "csrc_xpu/activation.h",
    "csrc_xpu/moe/moe_ops.h",
    "csrc_xpu/moe/moe_align_sum_kernels.cpp",
    "csrc_xpu/moe/moe_lora_align_sum_kernels.cpp",
    "csrc_xpu/moe/moe_gather.cpp",
    "csrc_xpu/moe/topk_softmax.cpp",
    "csrc_xpu/moe/grouped_topk.cpp",
    "csrc_xpu/moe/fused_grouped_topk.cpp",
    "csrc_xpu/moe/fused_moe_prologue.cpp",
    "csrc_xpu/moe/fused_moe_prologue.hpp",
    "csrc_xpu/grouped_gemm/grouped_gemm_interface.cpp",
    "csrc_xpu/grouped_gemm/grouped_gemm_interface.h",
    "csrc_xpu/grouped_gemm/xe_2/grouped_gemm_xe2.cpp",
    "csrc_xpu/grouped_gemm/xe_2/grouped_gemm_xe2.h",
    "csrc_xpu/grouped_gemm/xe_2/grouped_gemm_xe2.hpp",
    "csrc_xpu/grouped_gemm/xe_2/grouped_gemm_xe2_interface.hpp",
    "csrc_xpu/grouped_gemm/xe_2/gemm_xe2.hpp",
    "csrc_xpu/grouped_gemm/xe_2/gemm_xe2_policy.hpp",
]

[kernel.megablocks_cpu]
backend = "cpu"
depends = [
    "torch",
]
include = ["csrc_cpu"]
src = [
    "csrc_cpu/cpu_features.hpp",
    "csrc_cpu/moe_dispatcher.h",
    "csrc_cpu/moe_dispatcher.cpp",
    "csrc_cpu/moe_fallback.h",
    "csrc_cpu/moe_fallback.cpp",
]

[kernel.megablocks_cpu_avx512]
backend = "cpu"
cxx-flags = [
    "-O3",
    "-mfma",
    "-fopenmp",
    "-mf16c",
    "-mavx512f",
    "-mavx512bf16",
    "-mavx512vl",
    "-mavx512dq",
    "-mavx512bw",
    "-mavx512vbmi",
    "-mamx-tile",
    "-mamx-bf16",
    "-mamx-int8",
]
depends = [
    "torch",
]
include = ["csrc_cpu"]
src = [
    "csrc_cpu/common.h",
    "csrc_cpu/registration.h",
    "csrc_cpu/moe_ops.h",
    "csrc_cpu/cpu_moe_kernel.cpp",
    "csrc_cpu/cpu_moe_fp.cpp",
    "csrc_cpu/cpu_moe_int8.cpp",
]
