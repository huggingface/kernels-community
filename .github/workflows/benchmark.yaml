name: Benchmark
on:
  workflow_dispatch:
    inputs:
      kernel:
        description: "Kernel name (e.g. activation)"
        required: true
        type: string
  workflow_run:
    workflows: ["Build Release"]
    types: [completed]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.id || github.run_id }}
  cancel-in-progress: true

jobs:
  benchmark:
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    runs-on:
      group: aws-g6-12xlarge-plus
    steps:
      - uses: actions/checkout@v6
      - name: Get kernel name
        id: kernel
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "kernel=${{ inputs.kernel }}" >> $GITHUB_OUTPUT
          else
            PR_NUMBER=$(gh api "repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}" --jq '.pull_requests[0].number // empty')
            if [ -z "$PR_NUMBER" ]; then
              echo "No associated PR found, skipping"
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            PR_TITLE=$(gh pr view "$PR_NUMBER" --json title -q '.title')
            KERNEL=$(echo "$PR_TITLE" | cut -d: -f1 | xargs)
            echo "kernel=$KERNEL" >> $GITHUB_OUTPUT
          fi
      - uses: actions/setup-python@v6
        if: steps.kernel.outputs.skip != 'true'
        with:
          python-version: '3.12'
      - name: Install kernels
        if: steps.kernel.outputs.skip != 'true'
        run: pip install "kernels[benchmark] @ git+https://github.com/huggingface/kernels"
      - name: Benchmark kernel
        if: steps.kernel.outputs.skip != 'true'
        run: kernels benchmark "kernels-community/${{ steps.kernel.outputs.kernel }}"
