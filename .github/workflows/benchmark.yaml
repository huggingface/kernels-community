name: Benchmark
on:
  workflow_dispatch:
    inputs:
      kernel:
        description: "Kernel name (e.g. activation)"
        required: true
        type: string
  workflow_run:
    workflows: ["Build Release"]
    types: [completed]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.id || github.run_id }}
  cancel-in-progress: true

jobs:
  benchmark:
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    runs-on:
      group: aws-g6-12xlarge-plus
    steps:
      - uses: actions/checkout@v6
      - name: Get kernel name
        id: kernel
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "kernel=${{ inputs.kernel }}" >> $GITHUB_OUTPUT
          else
            PR_NUMBER=$(gh api "repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}" --jq '.pull_requests[0].number // empty')
            if [ -z "$PR_NUMBER" ]; then
              echo "No associated PR found, skipping"
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            PR_TITLE=$(gh pr view "$PR_NUMBER" --json title -q '.title')
            KERNEL=$(echo "$PR_TITLE" | cut -d: -f1 | xargs)
            echo "kernel=$KERNEL" >> $GITHUB_OUTPUT
          fi
      - uses: actions/setup-python@v6
        if: steps.kernel.outputs.skip != 'true'
        with:
          python-version: '3.12'
      - name: Install kernels
        if: steps.kernel.outputs.skip != 'true'
        run: pip install "kernels[benchmark] @ git+https://github.com/huggingface/kernels#subdirectory=kernels"
      - name: Benchmark kernel
        if: steps.kernel.outputs.skip != 'true'
        run: kernels benchmark "kernels-community/${{ steps.kernel.outputs.kernel }}" --branch main --visual benches
      - name: Ensure README has performance section
        if: steps.kernel.outputs.skip != 'true'
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          REPO="kernels-community/${{ steps.kernel.outputs.kernel }}"
          hf download "$REPO" README.md --local-dir /tmp/kernel-readme --revision main
          if ! grep -q '### Performance' /tmp/kernel-readme/README.md; then
          cat >> /tmp/kernel-readme/README.md << 'EOF'

          ### Performance

          <img class="dark:hidden border border-gray-200 dark:border-gray-700 rounded-lg" src="media/benches_light_animation.svg" />
          <img class="hidden dark:block border border-gray-200 dark:border-gray-700 rounded-lg" src="media/benches_dark_animation.svg" />

          <img class="dark:hidden border border-gray-200 dark:border-gray-700 rounded-lg" src="media/benches_light_latency.svg" />
          <img class="hidden dark:block border border-gray-200 dark:border-gray-700 rounded-lg" src="media/benches_dark_latency.svg" />

          <img class="dark:hidden border border-gray-200 dark:border-gray-700 rounded-lg" src="media/benches_light_throughput.svg" />
          <img class="hidden dark:block border border-gray-200 dark:border-gray-700 rounded-lg" src="media/benches_dark_throughput.svg" />
          EOF
          hf upload "$REPO" /tmp/kernel-readme/README.md README.md --revision main
          fi
      - name: Upload benchmark visuals
        if: steps.kernel.outputs.skip != 'true'
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: hf upload "kernels-community/${{ steps.kernel.outputs.kernel }}" media media --revision main
