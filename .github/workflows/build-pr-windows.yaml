name: Build PR (Windows)
on:
  pull_request:
    types: [opened, synchronize]
    paths-ignore:
      - "**/README.md"


concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  build-kernel:
    strategy:
      matrix:
        os: [ windows-2022 ]
        python: [ 3.11, 3.12 ]
        torch: [
          # { version: '2.9.1', cuda: '12.6.3', wheel: '126' },
          { version: '2.9.1', cuda: '12.8.1', wheel: '128' },
          # { version: '2.9.1', cuda: '13.0.1', wheel: '130' }
        ]

    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v6
      - name: Validate kernel directory
        id: validate
        shell: pwsh
        env:
          PRTITLE: ${{ github.event.pull_request.title }}
        run: |
          $KERNEL = python .github/workflows/validate-kernel-pr.py "pr" "$Env:PRTITLE"
          if ($LASTEXITCODE -eq 0) {
            echo "kernel=$KERNEL" >> $env:GITHUB_OUTPUT
            echo "skip=false" >> $env:GITHUB_OUTPUT
          } else {
            echo "skip=true" >> $env:GITHUB_OUTPUT
          }

      - name: Kernel Info
        if: steps.validate.outputs.skip == 'false'
        shell: pwsh
        run: |
          $KERNEL = "${{ steps.validate.outputs.kernel }}"
          Write-Output "Building Kernel: $KERNEL"

      - name: Kernel extract required builder version
        id: extract-builder-version
        if: steps.validate.outputs.skip == 'false'
        shell: pwsh
        run: |
          $KERNEL = "${{ steps.validate.outputs.kernel }}"
          $lock = Get-Content "${KERNEL}/flake.lock" | ConvertFrom-Json
          $revision = $lock.nodes."kernel-builder".locked.rev
          Write-Output "Building Kernel with revision: $revision"
          echo "revision=$revision" >> $env:GITHUB_OUTPUT

      - uses: Jimver/cuda-toolkit@v0.2.29
        if: steps.validate.outputs.skip == 'false'
        id: setup-cuda-toolkit
        with:
          cuda: ${{ matrix.torch.cuda }}

      - name: Setup Python
        if: steps.validate.outputs.skip == 'false'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install PyTorch
        if: steps.validate.outputs.skip == 'false'
        run: pip install torch --index-url https://download.pytorch.org/whl/cu${{ matrix.torch.wheel }}

      - name: Checkout kernel-builder
        if: steps.validate.outputs.skip == 'false'
        id: checkout-kernel-builder
        uses: actions/checkout@v5
        with:
          repository: huggingface/kernel-builder
          ref: "${{ steps.extract-builder-version.outputs.revision }}"
          path: kernel-builder

      - name: Cache Rust build
        if: steps.validate.outputs.skip == 'false'
        uses: actions/cache@v4
        with:
          path: |
            kernel-builder/build2cmake/target
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-rust-debug-${{ hashFiles('kernel-builder/build2cmake/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-debug-

      - name: Build build2cmake
        if: steps.validate.outputs.skip == 'false'
        working-directory: kernel-builder/build2cmake
        run: cargo build

      - name: Build kernel
        if: steps.validate.outputs.skip == 'false'
        shell: pwsh
        run: |
          $KERNEL = "${{ steps.validate.outputs.kernel }}"
          & "$env:GITHUB_WORKSPACE\kernel-builder\scripts\windows\builder.ps1" -Backend cuda -SourceFolder "$KERNEL" -BuildConfig Release -Build
